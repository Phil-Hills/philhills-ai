name: Q Protocol Attestation

on:
  push:
    branches: [ main ]
    paths:
      - 'identity.json'
      - 'README.md'
      - 'dashboard.html'
  workflow_dispatch:

jobs:
  cryptographic-sign:
    name: Sign Identity Assets
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
    - uses: actions/checkout@v3

    - name: Generate Content Hash (BLAKE3 Simulation)
      id: hash
      run: |
        # Generate generic SHA256 hashes as a proxy for Q-Protocol BLAKE3
        # In a full implementation, we would use b3sum
        sha256sum identity.json > identity.sig
        sha256sum README.md >> identity.sig
        echo "HASH_GENERATED=true" >> $GITHUB_ENV
        cat identity.sig

    - name: Sign with Sentinel Key
      if: env.HASH_GENERATED == 'true'
      env:
        # Assuming GPG Key or similar secret is available in real production
        # For this attestation, we use a HMAC signature if a secret is present, otherwise simulate
        SIGNING_KEY: ${{ secrets.Q_PROTOCOL_SIGNING_KEY }}
      run: |
        if [ -n "$SIGNING_KEY" ]; then
            echo "Signing assets with Q-Protocol Private Key..."
            openssl dgst -sha256 -hmac "$SIGNING_KEY" -out identity.token identity.sig
        else
            echo "::warning::No Signing Key found. Generating self-signed ephemeral token."
            echo "EPHEMERAL_SIGNATURE_$(date +%s)" > identity.token
        fi

    - name: Append Attestation to Identity
      run: |
        # Embed the signature into the identity.json context (updates the file)
        # We use a temp file to avoid reading/writing race conditions
        SIG=$(cat identity.token | base64 | tr -d '\n')
        jq --arg sig "$SIG" '.context.verification.signature = $sig' identity.json > identity.json.tmp && mv identity.json.tmp identity.json
        
        # Verify
        grep "signature" identity.json

    - name: Commit Attestation
      run: |
        git config --global user.name "Henry Agent"
        git config --global user.email "henry@philhills.ai"
        git add identity.json identity.sig identity.token
        git commit -m "Henry: Cryptographically Signed Identity Node [$(date)]" || echo "No changes to commit"
        git push
